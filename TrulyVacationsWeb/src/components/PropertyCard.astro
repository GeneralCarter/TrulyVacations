---
import type { OwnerRezListing } from "../lib/ownerRezTypes";
import { ownerRez } from "../lib/ownerRez";

interface Props {
  listing: OwnerRezListing;
}

const { listing } = Astro.props;
const propertyDetails = await ownerRez.getProperty(listing.property_id);
const fullProperty = { ...listing, ...propertyDetails };

const heroImage =
  fullProperty.photos && fullProperty.photos.length > 0
    ? fullProperty.photos[0].large_url
    : "https://placehold.co/600x400?text=No+Image";

const title =
  fullProperty.descriptions.headline || `Property ${fullProperty.property_id}`;
const minRate = fullProperty.nightly_rate_min;
const maxRate = fullProperty.nightly_rate_max;
const priceDisplay =
  minRate === maxRate ? `$${minRate}` : `$${minRate}-${maxRate}`;

const amenityList = fullProperty.amenity_call_outs
  ? fullProperty.amenity_call_outs.map((a) => a.text).slice(0, 5)
  : [];
---

<div class="flex flex-col md:flex-row border-b border-gray-200 py-8 gap-6">
  {/* Left: Image */}
  <div
    class="w-full md:w-2/5 rounded-lg shadow-md overflow-hidden relative aspect-[4/3] md:aspect-auto"
  >
    <img
      src={heroImage}
      alt={title}
      class="w-full h-full object-cover absolute md:static inset-0"
      loading="lazy"
    />
  </div>

  {/* Right: Content */}
  <div class="w-full md:w-3/5 flex flex-col gap-2">
    <div class="flex flex-wrap justify-between items-baseline gap-2">
      <h2
        class="text-2xl font-bold text-primary uppercase tracking-wide leading-tight"
      >
        <a href={`/property/${listing.property_id}`} class="hover:underline">
          {fullProperty.name}
        </a>
      </h2>
      <h2
        class="text-md font-bold text-gray-600 uppercase tracking-wide leading-tight"
      >
        {title}
      </h2>
      <span class="text-xl font-semibold text-gray-600 whitespace-nowrap">
        {priceDisplay}<span class="text-sm font-normal text-gray-500"
          >/night</span
        >
      </span>
    </div>

    <div class="text-sm text-gray-500 font-semibold mt-1">
      Size – {fullProperty.bedroom_count} Bedroom • {
        fullProperty.bathroom_count
      } Bathroom • Sleeps {fullProperty.sleeps_max}
    </div>

    {
      amenityList.length > 0 && (
        <div class="text-sm text-gray-500 flex flex-wrap items-center gap-2">
          <span class="font-semibold">Amenities –</span>
          <div>
            {fullProperty.amenity_call_outs.map((a) => (
              <span class="mx-1">
                <i class={`${a.icon}`} />
                {a.text}
              </span>
            ))}
          </div>
        </div>
      )
    }

    <p class="text-gray-600 my-4 line-clamp-3 leading-relaxed">
      {fullProperty.descriptions.description}
    </p>

    <div class="flex flex-wrap gap-2 mt-auto pt-2">
      {
        ["PHOTOS", "RATES", "AVAILABILITY", "DETAILS", "INQUIRE"].map(
          (label) => (
            <button class="border border-primary text-primary px-4 py-2 text-xs font-bold rounded-[3px] hover:bg-primary hover:text-white transition-colors duration-200 uppercase tracking-wider">
              {label}
            </button>
          ),
        )
      }
    </div>
  </div>
</div>
